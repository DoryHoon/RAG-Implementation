# 왜 내 RAG가 제대로 안 됐는가?
### — 일사량 CSV RAG 구현 실패 회고 —

---

## 1. RAG가 뭔지부터 다시 짚고 가자

RAG는 **Retrieval-Augmented Generation** 의 약자로, 직역하면 **"검색으로 보강된 생성"** 이다.

핵심 흐름은 이렇다:

```
질문 입력
   ↓
[Retrieval] 벡터DB에서 질문과 유사한 문서 조각 검색
   ↓
[Augmented] 검색된 문서를 Context로 LLM에 전달
   ↓
[Generation] LLM이 Context를 바탕으로 답변 생성
```

쉽게 말하면 LLM한테 **"이 자료 보고 답해"** 라고 시트를 쥐여주는 방식이다.  
LLM 혼자 알고 있는 지식이 아니라, 외부 문서를 검색해서 답변을 만드는 게 RAG의 핵심이다.

---

## 2. 그럼 내 코드에서 뭐가 문제였나?

### 문제 1: 데이터 자체가 RAG에 안 맞는 형태였다

RAG가 잘 동작하는 케이스는 이런 거다:
- 긴 보고서, 논문, 뉴스 기사처럼 **자연어로 쓰인 문서**
- "이 문서에서 ~에 대해 뭐라고 했어?" 같은 **내용 검색 질문**

근데 내가 넣은 건 이런 CSV였다:

```
일자: 01-01 00:00
지역: 광주
위도: 35.1729
경도: 126.8916
대기권 밖 일사량: 0
```

78,840개의 row가 전부 이런 형태다.  
**이건 자연어 문서가 아니라 숫자 데이터다.**  
RAG는 이런 수치 집계를 하도록 설계된 게 아니다.

---

### 문제 2: Retriever가 "전부"를 못 가져온다

"광주 1월 1일 일사량 평균 구해줘" 라는 질문을 하면,  
Retriever는 벡터 유사도 검색으로 **가장 관련 있어 보이는 문서 k개**만 가져온다.

기본 설정은 `k=4`, 즉 4개의 row만 가져온다.  
`k=20`으로 늘려도 마찬가지다. 전체 24개 시간대 row를 전부 가져오는 게 보장되지 않는다.

```
실제로 필요한 것: 광주 01-01 00:00 ~ 23:00, 총 24개 row 전부
Retriever가 가져온 것: 유사도 높은 것 몇 개 (운에 맡기는 상황)
```

그래서 틀린 답이 나올 수밖에 없었다.  
일부 데이터만 보고 평균을 냈으니 당연히 엉터리 값이 나온 거다.

---

### 문제 3: 인코딩 문제로 데이터 자체가 제대로 안 읽혔다

CSV 파일이 `cp949` 인코딩인데, CSVLoader에 인코딩 설정을 안 해줬다.

```python
# ❌ 기존 코드 - 인코딩 설정 없음
loader = CSVLoader(file_path='...csv')

# ✅ 수정된 코드
loader = CSVLoader(file_path='...csv', encoding='cp949')
```

한글이 포함된 CSV를 읽을 때 인코딩을 명시하지 않으면  
파일을 아예 못 읽거나, 한글이 깨진 상태로 벡터화되어 검색 품질이 크게 떨어진다.

---

### 문제 4: Chunk 설정이 데이터 구조에 안 맞았다

처음에 `chunk_size=1000`으로 설정했는데, 각 row의 내용은 100자도 안 된다.

```
일자: 01-01 00:00
지역: 광주
위도: 35.1729
경도: 126.8916
대기권 밖 일사량: 0
→ 약 60자
```

`chunk_size=1000`이면 여러 row가 하나의 chunk로 뭉쳐진다.  
그럼 "광주 데이터"를 검색했을 때 다른 지역 데이터까지 섞인 chunk가 검색될 수 있다.

```python
# ❌ 기존 코드
text_splitter = RecursiveCharacterTextSplitter(chunk_size=1000, chunk_overlap=50)

# ✅ 수정된 코드
text_splitter = RecursiveCharacterTextSplitter(chunk_size=200, chunk_overlap=0)
```

---

## 3. 정리: 이번 시도가 잘 안 된 이유 한 줄 요약

> **RAG는 "문서에서 내용을 찾는" 도구인데,  
> 나는 "숫자 데이터를 집계하는" 용도로 쓰려 했다.**

| 항목 | RAG가 잘 맞는 경우 | 이번 케이스 |
|------|------------------|-------------|
| 데이터 형태 | 자연어 문서 (보고서, 기사) | 수치형 CSV |
| 질문 유형 | 내용 검색, 요약 | 집계, 평균, 비교 |
| 검색 방식 | 유사도 검색으로 충분 | 전체 데이터 집계 필요 |
| 적합한 도구 | RAG | pandas + LLM |